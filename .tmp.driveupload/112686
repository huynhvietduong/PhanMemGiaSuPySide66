# dialogs/tree_manager_dialog.py
from PySide6 import QtWidgets, QtCore, QtGui
from PySide6.QtCore import Qt
from .tree_node_dialog import TreeNodeDialog


# #(Dialog qu·∫£n l√Ω c√¢y th∆∞ m·ª•c n√¢ng cao v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng)
class TreeManagerDialog(QtWidgets.QDialog):
    """Dialog qu·∫£n l√Ω c√¢y th∆∞ m·ª•c n√¢ng cao"""

    def __init__(self, db_manager, parent=None):
        super().__init__(parent)
        self.db = db_manager
        self.setWindowTitle("‚öôÔ∏è Qu·∫£n l√Ω c√¢y th∆∞ m·ª•c")
        self.setModal(True)
        self.resize(900, 700)
        self.setMinimumSize(800, 600)

        self._build_ui()
        self._load_tree_data()
        self._setup_connections()

    def _build_ui(self):
        """X√¢y d·ª±ng giao di·ªán"""
        layout = QtWidgets.QVBoxLayout(self)
        layout.setSpacing(8)
        layout.setContentsMargins(10, 10, 10, 10)

        # Header title
        title = QtWidgets.QLabel("üå≤ Qu·∫£n l√Ω c√¢y th∆∞ m·ª•c n√¢ng cao")
        title.setStyleSheet("""
            QLabel {
                font-size: 18px;
                font-weight: bold;
                color: #2E86AB;
                padding: 10px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 #f8f9fa, stop:1 #e9ecef);
                border-radius: 8px;
                border: 1px solid #dee2e6;
            }
        """)
        title.setAlignment(Qt.AlignCenter)
        layout.addWidget(title)

        # Thanh t√¨m ki·∫øm
        search_layout = QtWidgets.QHBoxLayout()
        search_layout.addWidget(QtWidgets.QLabel("üîç T√¨m ki·∫øm:"))

        self.search_input = QtWidgets.QLineEdit()
        self.search_input.setPlaceholderText("Nh·∫≠p t√™n node c·∫ßn t√¨m...")
        self.search_input.setStyleSheet("padding: 5px; border-radius: 4px; border: 1px solid #ccc;")
        search_layout.addWidget(self.search_input)

        clear_search_btn = QtWidgets.QPushButton("‚ùå X√≥a")
        clear_search_btn.setMaximumWidth(60)
        clear_search_btn.clicked.connect(lambda: self.search_input.clear())
        search_layout.addWidget(clear_search_btn)

        layout.addLayout(search_layout)

        # Toolbar
        self._create_toolbar(layout)

        # Tree widget v·ªõi styling ƒë·∫πp
        self._create_tree_widget(layout)

        # Panel th√¥ng tin node ƒë∆∞·ª£c ch·ªçn
        self._create_info_panel(layout)

        # Button layout
        self._create_button_layout(layout)

    def _create_toolbar(self, parent_layout):
        """T·∫°o toolbar v·ªõi c√°c action"""
        toolbar = QtWidgets.QToolBar()
        toolbar.setToolButtonStyle(Qt.ToolButtonTextBesideIcon)
        toolbar.setStyleSheet("""
            QToolBar {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                padding: 5px;
                spacing: 5px;
            }
            QToolBar QToolButton {
                padding: 6px 10px;
                border-radius: 4px;
                border: 1px solid transparent;
            }
            QToolBar QToolButton:hover {
                background: #e9ecef;
                border: 1px solid #ced4da;
            }
        """)

        # Actions
        self.add_action = toolbar.addAction("‚ûï Th√™m nh√°nh")
        self.add_action.triggered.connect(self._add_node)

        self.edit_action = toolbar.addAction("‚úèÔ∏è S·ª≠a nh√°nh")
        self.edit_action.triggered.connect(self._edit_node)
        self.edit_action.setEnabled(False)

        self.delete_action = toolbar.addAction("üóëÔ∏è X√≥a nh√°nh")
        self.delete_action.triggered.connect(self._delete_node)
        self.delete_action.setEnabled(False)

        toolbar.addSeparator()

        self.copy_action = toolbar.addAction("üìã Sao ch√©p")
        self.copy_action.triggered.connect(self._copy_node)
        self.copy_action.setEnabled(False)

        toolbar.addSeparator()

        self.expand_action = toolbar.addAction("üìñ M·ªü r·ªông t·∫•t c·∫£")
        self.expand_action.triggered.connect(lambda: self.tree_table.expandAll())

        self.collapse_action = toolbar.addAction("üìö Thu g·ªçn t·∫•t c·∫£")
        self.collapse_action.triggered.connect(lambda: self.tree_table.collapseAll())

        toolbar.addSeparator()

        self.export_action = toolbar.addAction("üì§ Xu·∫•t c·∫•u tr√∫c")
        self.export_action.triggered.connect(self._export_structure)

        self.import_action = toolbar.addAction("üì• Nh·∫≠p c·∫•u tr√∫c")
        self.import_action.triggered.connect(self._import_structure)

        parent_layout.addWidget(toolbar)

    def _create_tree_widget(self, parent_layout):
        """T·∫°o tree widget v·ªõi styling"""
        self.tree_table = QtWidgets.QTreeWidget()
        self.tree_table.setHeaderLabels(["üìù T√™n", "üè∑Ô∏è C·∫•p ƒë·ªô", "üìä S·ªë c√¢u h·ªèi", "üìÑ M√¥ t·∫£"])

        # ƒê·∫∑t ƒë·ªô r·ªông c·ªôt
        self.tree_table.setColumnWidth(0, 300)
        self.tree_table.setColumnWidth(1, 120)
        self.tree_table.setColumnWidth(2, 100)
        self.tree_table.setColumnWidth(3, 250)

        # Styling cho tree
        self.tree_table.setStyleSheet("""
            QTreeWidget {
                border: 1px solid #dee2e6;
                border-radius: 8px;
                background: white;
                alternate-background-color: #f8f9fa;
                font-size: 13px;
            }
            QTreeWidget::item {
                padding: 8px;
                border-bottom: 1px solid #f0f0f0;
            }
            QTreeWidget::item:selected {
                background: #007bff;
                color: white;
            }
            QTreeWidget::item:hover {
                background: #e3f2fd;
            }
            QTreeWidget::branch:has-children {
                image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PGNpcmNsZSBjeD0iOCIgY3k9IjgiIHI9IjQiIGZpbGw9IiM2YzU3ZGQiLz48L3N2Zz4=');
            }
            QHeaderView::section {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 8px;
                font-weight: bold;
            }
        """)

        # Enable features
        self.tree_table.setAlternatingRowColors(True)
        self.tree_table.setRootIsDecorated(True)
        self.tree_table.setExpandsOnDoubleClick(False)
        self.tree_table.setSortingEnabled(True)

        parent_layout.addWidget(self.tree_table)

    def _create_info_panel(self, parent_layout):
        """T·∫°o panel th√¥ng tin node ƒë∆∞·ª£c ch·ªçn"""
        info_group = QtWidgets.QGroupBox("‚ÑπÔ∏è Th√¥ng tin chi ti·∫øt")
        info_group.setStyleSheet("""
            QGroupBox {
                font-weight: bold;
                border: 1px solid #ced4da;
                border-radius: 6px;
                margin-top: 10px;
                padding-top: 10px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px 0 5px;
            }
        """)
        info_layout = QtWidgets.QFormLayout(info_group)

        self.info_id = QtWidgets.QLabel("Ch∆∞a ch·ªçn node")
        self.info_name = QtWidgets.QLabel("-")
        self.info_level = QtWidgets.QLabel("-")
        self.info_parent = QtWidgets.QLabel("-")
        self.info_children_count = QtWidgets.QLabel("-")
        self.info_question_count = QtWidgets.QLabel("-")
        self.info_created = QtWidgets.QLabel("-")

        info_layout.addRow("üÜî ID:", self.info_id)
        info_layout.addRow("üìù T√™n:", self.info_name)
        info_layout.addRow("üè∑Ô∏è C·∫•p ƒë·ªô:", self.info_level)
        info_layout.addRow("üëÜ Node cha:", self.info_parent)
        info_layout.addRow("üë∂ S·ªë node con:", self.info_children_count)
        info_layout.addRow("‚ùì S·ªë c√¢u h·ªèi:", self.info_question_count)
        info_layout.addRow("üìÖ Ng√†y t·∫°o:", self.info_created)

        info_group.setMaximumHeight(200)
        parent_layout.addWidget(info_group)

    def _create_button_layout(self, parent_layout):
        """T·∫°o button layout"""
        button_layout = QtWidgets.QHBoxLayout()

        # Th·ªëng k√™ t·ªïng quan
        self.stats_label = QtWidgets.QLabel()
        self.stats_label.setStyleSheet("color: #6c757d; font-style: italic;")
        button_layout.addWidget(self.stats_label)

        button_layout.addStretch()

        # Refresh button
        refresh_btn = QtWidgets.QPushButton("üîÑ L√†m m·ªõi")
        refresh_btn.clicked.connect(self._load_tree_data)
        button_layout.addWidget(refresh_btn)

        # Close button
        close_btn = QtWidgets.QPushButton("‚úÖ ƒê√≥ng")
        close_btn.setStyleSheet("""
            QPushButton {
                background: #28a745;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                font-weight: bold;
            }
            QPushButton:hover {
                background: #218838;
            }
        """)
        close_btn.clicked.connect(self.accept)
        button_layout.addWidget(close_btn)

        parent_layout.addLayout(button_layout)

    def _setup_connections(self):
        """Thi·∫øt l·∫≠p k·∫øt n·ªëi signals"""
        # Tree selection changed
        self.tree_table.itemSelectionChanged.connect(self._on_selection_changed)

        # Double click to edit
        self.tree_table.itemDoubleClicked.connect(lambda: self._edit_node())

        # Context menu
        self.tree_table.setContextMenuPolicy(Qt.CustomContextMenu)
        self.tree_table.customContextMenuRequested.connect(self._show_context_menu)

        # Search
        self.search_input.textChanged.connect(self._filter_tree)

    def _load_tree_data(self):
        """Load d·ªØ li·ªáu c√¢y t·ª´ database"""
        try:
            self.tree_table.clear()

            # Get all nodes
            rows = self.db.execute_query(
                """
                SELECT et.*, 
                       (SELECT COUNT(*) FROM exercise_tree WHERE parent_id = et.id) as children_count,
                       (SELECT COUNT(*) FROM question_bank WHERE tree_id = et.id) as question_count
                FROM exercise_tree et 
                ORDER BY et.id
                """,
                fetch="all"
            ) or []

            # Build tree structure
            nodes = {}
            root_nodes = []

            # Create tree items
            for row in rows:
                node_dict = dict(row)
                item = QtWidgets.QTreeWidgetItem()

                # Set data
                item.setText(0, node_dict.get('name', ''))
                item.setText(1, node_dict.get('level', ''))
                item.setText(2, str(node_dict.get('question_count', 0)))
                item.setText(3, node_dict.get('description', '')[:50] + '...'
                if node_dict.get('description') and len(node_dict.get('description', '')) > 50
                else node_dict.get('description', ''))

                # Store full data
                item.setData(0, Qt.UserRole, node_dict)

                # Add level-based icons
                level_icons = {
                    'M√¥n': 'üìö',
                    'L·ªõp': 'üéì',
                    'Ch·ªß ƒë·ªÅ': 'üìñ',
                    'D·∫°ng': 'üìù',
                    'M·ª©c ƒë·ªô': '‚≠ê'
                }
                icon = level_icons.get(node_dict.get('level', ''), 'üìÑ')
                item.setText(0, f"{icon} {node_dict.get('name', '')}")

                nodes[node_dict['id']] = item

                if node_dict.get('parent_id') is None:
                    root_nodes.append(item)

            # Build parent-child relationships
            for row in rows:
                node_dict = dict(row)
                if node_dict.get('parent_id') and node_dict['parent_id'] in nodes:
                    parent_item = nodes[node_dict['parent_id']]
                    child_item = nodes[node_dict['id']]
                    parent_item.addChild(child_item)

            # Add root nodes to tree
            for root in root_nodes:
                self.tree_table.addTopLevelItem(root)

            # Update statistics
            total_nodes = len(nodes)
            total_questions = sum(dict(row).get('question_count', 0) for row in rows)
            self.stats_label.setText(f"üìä T·ªïng: {total_nodes} node, {total_questions} c√¢u h·ªèi")

            # Expand level 1
            self.tree_table.expandToDepth(0)

        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ load d·ªØ li·ªáu c√¢y: {e}")

    def _on_selection_changed(self):
        """X·ª≠ l√Ω khi selection thay ƒë·ªïi"""
        selected_items = self.tree_table.selectedItems()

        if selected_items:
            item = selected_items[0]
            node_data = item.data(0, Qt.UserRole)

            if node_data:
                # Update info panel
                self.info_id.setText(str(node_data.get('id', '')))
                self.info_name.setText(node_data.get('name', ''))
                self.info_level.setText(node_data.get('level', ''))

                # Get parent name
                parent_id = node_data.get('parent_id')
                if parent_id:
                    parent_row = self.db.execute_query(
                        "SELECT name FROM exercise_tree WHERE id = ?",
                        (parent_id,), fetch="one"
                    )
                    parent_name = dict(parent_row).get('name', 'Kh√¥ng x√°c ƒë·ªãnh') if parent_row else 'Kh√¥ng x√°c ƒë·ªãnh'
                else:
                    parent_name = '(Root)'
                self.info_parent.setText(parent_name)

                self.info_children_count.setText(str(node_data.get('children_count', 0)))
                self.info_question_count.setText(str(node_data.get('question_count', 0)))
                self.info_created.setText('N/A')  # N·∫øu c√≥ tr∆∞·ªùng created_at th√¨ d√πng

            # Enable/disable actions
            self.edit_action.setEnabled(True)
            self.delete_action.setEnabled(node_data.get('children_count', 0) == 0)  # Ch·ªâ x√≥a ƒë∆∞·ª£c n·∫øu kh√¥ng c√≥ con
            self.copy_action.setEnabled(True)
        else:
            # Clear info panel
            self.info_id.setText("Ch∆∞a ch·ªçn node")
            self.info_name.setText("-")
            self.info_level.setText("-")
            self.info_parent.setText("-")
            self.info_children_count.setText("-")
            self.info_question_count.setText("-")
            self.info_created.setText("-")

            # Disable actions
            self.edit_action.setEnabled(False)
            self.delete_action.setEnabled(False)
            self.copy_action.setEnabled(False)

    def _filter_tree(self):
        """L·ªçc c√¢y theo t·ª´ kh√≥a t√¨m ki·∫øm"""
        search_text = self.search_input.text().lower().strip()

        if not search_text:
            # Show all items
            self._show_all_items()
        else:
            # Hide/show items based on search
            self._filter_items_recursive(self.tree_table.invisibleRootItem(), search_text)

    def _show_all_items(self):
        """Hi·ªÉn th·ªã t·∫•t c·∫£ items"""
        iterator = QtWidgets.QTreeWidgetItemIterator(self.tree_table)
        while iterator.value():
            iterator.value().setHidden(False)
            iterator += 1

    def _filter_items_recursive(self, parent_item, search_text):
        """ƒê·ªá quy filter items"""
        for i in range(parent_item.childCount()):
            child = parent_item.child(i)
            child_text = child.text(0).lower()

            # Check if this item or any descendant matches
            should_show = search_text in child_text or self._has_matching_descendant(child, search_text)
            child.setHidden(not should_show)

            # If showing, expand to show children
            if should_show:
                child.setExpanded(True)

            # Continue recursively
            self._filter_items_recursive(child, search_text)

    def _has_matching_descendant(self, item, search_text):
        """Ki·ªÉm tra c√≥ con n√†o match kh√¥ng"""
        for i in range(item.childCount()):
            child = item.child(i)
            if search_text in child.text(0).lower():
                return True
            if self._has_matching_descendant(child, search_text):
                return True
        return False

    def _add_node(self):
        """Th√™m node m·ªõi"""
        selected_items = self.tree_table.selectedItems()
        parent_id = None

        if selected_items:
            parent_data = selected_items[0].data(0, Qt.UserRole)
            parent_id = parent_data.get('id') if parent_data else None

        dialog = TreeNodeDialog(self.db, mode="add", parent=self)
        if parent_id:
            dialog.set_parent_id(parent_id)

        if dialog.exec() == QtWidgets.QDialog.Accepted:
            self._load_tree_data()
            QtWidgets.QMessageBox.information(self, "Th√†nh c√¥ng", "ƒê√£ th√™m node m·ªõi!")

    def _edit_node(self):
        """S·ª≠a node ƒë∆∞·ª£c ch·ªçn"""
        selected_items = self.tree_table.selectedItems()
        if not selected_items:
            QtWidgets.QMessageBox.warning(self, "Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn node ƒë·ªÉ s·ª≠a")
            return

        node_data = selected_items[0].data(0, Qt.UserRole)
        if not node_data:
            return

        dialog = TreeNodeDialog(self.db, mode="edit", node_id=node_data['id'], parent=self)
        if dialog.exec() == QtWidgets.QDialog.Accepted:
            self._load_tree_data()
            QtWidgets.QMessageBox.information(self, "Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t node!")

    def _delete_node(self):
        """X√≥a node ƒë∆∞·ª£c ch·ªçn"""
        selected_items = self.tree_table.selectedItems()
        if not selected_items:
            QtWidgets.QMessageBox.warning(self, "Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn node ƒë·ªÉ x√≥a")
            return

        node_data = selected_items[0].data(0, Qt.UserRole)
        if not node_data:
            return

        # Ki·ªÉm tra c√≥ children kh√¥ng
        if node_data.get('children_count', 0) > 0:
            QtWidgets.QMessageBox.warning(
                self, "Kh√¥ng th·ªÉ x√≥a",
                f"Node '{node_data['name']}' c√≥ {node_data['children_count']} node con.\n"
                "Vui l√≤ng x√≥a c√°c node con tr∆∞·ªõc."
            )
            return

        # Ki·ªÉm tra c√≥ c√¢u h·ªèi kh√¥ng
        if node_data.get('question_count', 0) > 0:
            reply = QtWidgets.QMessageBox.question(
                self, "X√°c nh·∫≠n x√≥a",
                f"Node '{node_data['name']}' c√≥ {node_data['question_count']} c√¢u h·ªèi.\n"
                "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a? (C√°c c√¢u h·ªèi s·∫Ω kh√¥ng b·ªã x√≥a nh∆∞ng s·∫Ω m·∫•t li√™n k·∫øt)",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )
        else:
            reply = QtWidgets.QMessageBox.question(
                self, "X√°c nh·∫≠n x√≥a",
                f"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a node '{node_data['name']}'?",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )

        if reply == QtWidgets.QMessageBox.Yes:
            try:
                self.db.execute_query("DELETE FROM exercise_tree WHERE id = ?", (node_data['id'],))
                self._load_tree_data()
                QtWidgets.QMessageBox.information(self, "Th√†nh c√¥ng", "ƒê√£ x√≥a node!")
            except Exception as e:
                QtWidgets.QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ x√≥a node: {e}")

    def _copy_node(self):
        """Sao ch√©p node ƒë∆∞·ª£c ch·ªçn"""
        selected_items = self.tree_table.selectedItems()
        if not selected_items:
            QtWidgets.QMessageBox.warning(self, "Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn node ƒë·ªÉ sao ch√©p")
            return

        node_data = selected_items[0].data(0, Qt.UserRole)
        if not node_data:
            return

        try:
            new_name = f"{node_data['name']} (Sao ch√©p)"
            self.db.execute_query(
                "INSERT INTO exercise_tree (parent_id, name, level, description) VALUES (?, ?, ?, ?)",
                (node_data.get('parent_id'), new_name, node_data.get('level'), node_data.get('description'))
            )
            self._load_tree_data()
            QtWidgets.QMessageBox.information(self, "Th√†nh c√¥ng", f"ƒê√£ sao ch√©p node '{new_name}'!")
        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ sao ch√©p node: {e}")

    def _export_structure(self):
        """Xu·∫•t c·∫•u tr√∫c c√¢y ra file JSON"""
        try:
            file_path, _ = QtWidgets.QFileDialog.getSaveFileName(
                self, "Xu·∫•t c·∫•u tr√∫c c√¢y", "tree_structure.json", "JSON files (*.json)"
            )

            if not file_path:
                return

            # Get all data
            rows = self.db.execute_query("SELECT * FROM exercise_tree ORDER BY id", fetch="all") or []
            data = [dict(row) for row in rows]

            # Save to file
            import json
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)

            QtWidgets.QMessageBox.information(self, "Th√†nh c√¥ng", f"ƒê√£ xu·∫•t c·∫•u tr√∫c ra file:\n{file_path}")

        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ xu·∫•t file: {e}")

    def _import_structure(self):
        """Nh·∫≠p c·∫•u tr√∫c c√¢y t·ª´ file JSON"""
        try:
            file_path, _ = QtWidgets.QFileDialog.getOpenFileName(
                self, "Nh·∫≠p c·∫•u tr√∫c c√¢y", "", "JSON files (*.json)"
            )

            if not file_path:
                return

            # Confirm import
            reply = QtWidgets.QMessageBox.question(
                self, "X√°c nh·∫≠n nh·∫≠p",
                "Thao t√°c n√†y s·∫Ω th√™m c√°c node m·ªõi v√†o c√¢y hi·ªán t·∫°i.\nB·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?",
                QtWidgets.QMessageBox.Yes | QtWidgets.QMessageBox.No
            )

            if reply != QtWidgets.QMessageBox.Yes:
                return

            # Read and import
            import json
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)

            imported_count = 0
            for item in data:
                try:
                    # Check if already exists
                    existing = self.db.execute_query(
                        "SELECT id FROM exercise_tree WHERE name = ? AND level = ?",
                        (item.get('name'), item.get('level')), fetch="one"
                    )

                    if not existing:
                        self.db.execute_query(
                            "INSERT INTO exercise_tree (parent_id, name, level, description) VALUES (?, ?, ?, ?)",
                            (item.get('parent_id'), item.get('name'), item.get('level'), item.get('description'))
                        )
                        imported_count += 1
                except:
                    continue  # Skip invalid items

            self._load_tree_data()
            QtWidgets.QMessageBox.information(self, "Th√†nh c√¥ng", f"ƒê√£ nh·∫≠p {imported_count} node m·ªõi!")

        except Exception as e:
            QtWidgets.QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ nh·∫≠p file: {e}")

    def _show_context_menu(self, position):
        """Hi·ªÉn th·ªã context menu"""
        item = self.tree_table.itemAt(position)

        menu = QtWidgets.QMenu(self)

        # Add actions
        add_action = menu.addAction("‚ûï Th√™m nh√°nh")
        add_action.triggered.connect(self._add_node)

        if item:
            node_data = item.data(0, Qt.UserRole)

            add_child_action = menu.addAction("üë∂ Th√™m nh√°nh con")
            add_child_action.triggered.connect(self._add_node)

            menu.addSeparator()

            edit_action = menu.addAction("‚úèÔ∏è S·ª≠a")
            edit_action.triggered.connect(self._edit_node)

            copy_action = menu.addAction("üìã Sao ch√©p")
            copy_action.triggered.connect(self._copy_node)

            if node_data and node_data.get('children_count', 0) == 0:
                delete_action = menu.addAction("üóëÔ∏è X√≥a")
                delete_action.triggered.connect(self._delete_node)

            menu.addSeparator()

            expand_action = menu.addAction("üìñ M·ªü r·ªông")
            expand_action.triggered.connect(lambda: item.setExpanded(True))

            collapse_action = menu.addAction("üìö Thu g·ªçn")
            collapse_action.triggered.connect(lambda: item.setExpanded(False))

        menu.exec(self.tree_table.mapToGlobal(position))