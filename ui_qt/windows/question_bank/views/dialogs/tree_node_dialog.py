"""
Tree Node Dialog - Dialog th√™m/s·ª≠a node trong c√¢y th∆∞ m·ª•c
File: ui_qt/windows/question_bank/views/dialogs/tree_node_dialog.py
"""

import re
from typing import Optional, Dict, Any, List
from PySide6 import QtCore, QtGui, QtWidgets
from PySide6.QtCore import Qt, Signal
from PySide6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout, QFormLayout,
    QLabel, QPushButton, QGroupBox, QWidget,
    QLineEdit, QComboBox, QTextEdit, QSpinBox,
    QCheckBox, QMessageBox, QTreeWidget, QTreeWidgetItem
)


class TreeNodeDialog(QDialog):
    """Dialog th√™m/s·ª≠a node trong c√¢y th∆∞ m·ª•c"""

    # Signals
    node_saved = Signal(int)  # Ph√°t t√≠n hi·ªáu khi l∆∞u th√†nh c√¥ng

    def __init__(self, db_manager, mode="add", node_id=None, parent=None):
        super().__init__(parent)
        self.db = db_manager
        self.mode = mode  # "add" ho·∫∑c "edit"
        self.node_id = node_id
        self.parent_id: Optional[int] = None
        self.node_data: Optional[Dict] = None

        self._setup_window()
        self._setup_ui()
        self._setup_connections()

        if self.mode == "edit" and self.node_id:
            self._load_node_data()
        elif self.mode == "add":
            self._set_default_values()

    def _setup_window(self):
        """Thi·∫øt l·∫≠p c·ª≠a s·ªï"""
        title = "‚úèÔ∏è Ch·ªânh s·ª≠a th∆∞ m·ª•c" if self.mode == "edit" else "‚ûï Th√™m th∆∞ m·ª•c m·ªõi"
        self.setWindowTitle(title)
        self.setModal(True)
        self.resize(500, 450)

    def _setup_ui(self):
        """Thi·∫øt l·∫≠p giao di·ªán"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(15, 15, 15, 15)
        layout.setSpacing(15)

        # Main form
        self._create_main_form(layout)

        # Parent selection (ch·ªâ khi add)
        if self.mode == "add":
            self._create_parent_selection(layout)

        # Preview section
        self._create_preview_section(layout)

        # Buttons
        self._create_buttons(layout)

    def _create_main_form(self, layout: QVBoxLayout):
        """T·∫°o form ch√≠nh"""
        form_group = QGroupBox("üìù Th√¥ng tin th∆∞ m·ª•c")
        form_layout = QFormLayout(form_group)
        form_layout.setLabelAlignment(Qt.AlignRight)

        # Node name
        self.name_edit = QLineEdit()
        self.name_edit.setPlaceholderText("Nh·∫≠p t√™n th∆∞ m·ª•c...")
        self.name_edit.setMaxLength(100)
        form_layout.addRow("üìÅ T√™n th∆∞ m·ª•c:", self.name_edit)

        # Node type/level
        self.level_combo = QComboBox()
        self.level_combo.addItems([
            "folder",  # Th∆∞ m·ª•c th√¥ng th∆∞·ªùng
            "subject",  # M√¥n h·ªçc
            "chapter",  # Ch∆∞∆°ng
            "section",  # Ph·∫ßn/M·ª•c
            "topic",  # Ch·ªß ƒë·ªÅ
            "difficulty",  # M·ª©c ƒë·ªô kh√≥
            "exam_type"  # Lo·∫°i ƒë·ªÅ thi
        ])
        self.level_combo.currentTextChanged.connect(self._on_level_changed)
        form_layout.addRow("üìä Lo·∫°i:", self.level_combo)

        # Description
        self.description_edit = QTextEdit()
        self.description_edit.setMaximumHeight(80)
        self.description_edit.setPlaceholderText("M√¥ t·∫£ th∆∞ m·ª•c (t√πy ch·ªçn)...")
        form_layout.addRow("üìÑ M√¥ t·∫£:", self.description_edit)

        # Order/Position
        self.order_spin = QSpinBox()
        self.order_spin.setRange(0, 999)
        self.order_spin.setValue(0)
        self.order_spin.setToolTip("Th·ª© t·ª± hi·ªÉn th·ªã (0 = t·ª± ƒë·ªông)")
        form_layout.addRow("üî¢ Th·ª© t·ª±:", self.order_spin)

        # Color (for UI highlighting)
        self.color_combo = QComboBox()
        self.color_combo.addItems([
            "M·∫∑c ƒë·ªãnh",
            "üî¥ ƒê·ªè (Quan tr·ªçng)",
            "üü° V√†ng (C·∫£nh b√°o)",
            "üü¢ Xanh (Ho√†n th√†nh)",
            "üîµ Xanh d∆∞∆°ng (Th√¥ng tin)",
            "üü£ T√≠m (N√¢ng cao)"
        ])
        form_layout.addRow("üé® M√†u s·∫Øc:", self.color_combo)

        layout.addWidget(form_group)

    def _create_parent_selection(self, layout: QVBoxLayout):
        """T·∫°o ph·∫ßn ch·ªçn parent (ch·ªâ khi add)"""
        parent_group = QGroupBox("üëÜ Ch·ªçn th∆∞ m·ª•c cha")
        parent_layout = QVBoxLayout(parent_group)

        # Current parent info
        self.parent_info_label = QLabel("Ch∆∞a ch·ªçn th∆∞ m·ª•c cha")
        self.parent_info_label.setStyleSheet("""
            QLabel {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 8px;
                border-radius: 4px;
            }
        """)
        parent_layout.addWidget(self.parent_info_label)

        # Buttons
        parent_buttons_layout = QHBoxLayout()

        select_parent_btn = QPushButton("üìÅ Ch·ªçn th∆∞ m·ª•c cha")
        select_parent_btn.clicked.connect(self._select_parent)

        clear_parent_btn = QPushButton("‚ùå X√≥a l·ª±a ch·ªçn")
        clear_parent_btn.clicked.connect(self._clear_parent)

        parent_buttons_layout.addWidget(select_parent_btn)
        parent_buttons_layout.addWidget(clear_parent_btn)
        parent_buttons_layout.addStretch()

        parent_layout.addLayout(parent_buttons_layout)
        layout.addWidget(parent_group)

    def _create_preview_section(self, layout: QVBoxLayout):
        """T·∫°o ph·∫ßn preview"""
        preview_group = QGroupBox("üëÅÔ∏è Xem tr∆∞·ªõc")
        preview_layout = QVBoxLayout(preview_group)

        self.preview_label = QLabel("Preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y")
        self.preview_label.setStyleSheet("""
            QLabel {
                background: white;
                border: 2px dashed #dee2e6;
                padding: 15px;
                border-radius: 8px;
                color: #6c757d;
                font-style: italic;
            }
        """)
        self.preview_label.setAlignment(Qt.AlignCenter)
        self.preview_label.setMinimumHeight(60)

        preview_layout.addWidget(self.preview_label)
        layout.addWidget(preview_group)

    def _create_buttons(self, layout: QVBoxLayout):
        """T·∫°o n√∫t ƒëi·ªÅu khi·ªÉn"""
        button_layout = QHBoxLayout()

        # Validate button
        validate_btn = QPushButton("‚úÖ Ki·ªÉm tra")
        validate_btn.clicked.connect(self._validate_input)
        button_layout.addWidget(validate_btn)

        button_layout.addStretch()

        # Cancel button
        cancel_btn = QPushButton("‚ùå H·ªßy")
        cancel_btn.clicked.connect(self.reject)
        button_layout.addWidget(cancel_btn)

        # Save button
        save_text = "üíæ C·∫≠p nh·∫≠t" if self.mode == "edit" else "üíæ T·∫°o m·ªõi"
        self.save_btn = QPushButton(save_text)
        self.save_btn.setDefault(True)
        self.save_btn.clicked.connect(self._save_node)
        self.save_btn.setStyleSheet("""
            QPushButton {
                background: #28a745;
                color: white;
                font-weight: bold;
                padding: 8px 16px;
                border-radius: 4px;
                border: none;
            }
            QPushButton:hover {
                background: #218838;
            }
        """)
        button_layout.addWidget(self.save_btn)

        layout.addLayout(button_layout)

    def _setup_connections(self):
        """Thi·∫øt l·∫≠p k·∫øt n·ªëi"""
        # Real-time preview update
        self.name_edit.textChanged.connect(self._update_preview)
        self.level_combo.currentTextChanged.connect(self._update_preview)
        self.description_edit.textChanged.connect(self._update_preview)

        # Keyboard shortcuts
        QtGui.QShortcut(QtGui.QKeySequence("Ctrl+S"), self, self._save_node)
        QtGui.QShortcut(QtGui.QKeySequence("Escape"), self, self.reject)

    # ========== DATA LOADING ==========

    def _load_node_data(self):
        """Load d·ªØ li·ªáu node (khi edit)"""
        if not self.node_id:
            return

        try:
            node = self.db.execute_query(
                "SELECT * FROM exercise_tree WHERE id = ?",
                (self.node_id,), fetch="one"
            )

            if not node:
                QMessageBox.warning(self, "L·ªói", "Kh√¥ng t√¨m th·∫•y node!")
                self.reject()
                return

            # Convert to dict
            if hasattr(node, 'keys'):
                self.node_data = dict(node)
            else:
                self.node_data = node

            # Fill form
            self.name_edit.setText(self.node_data.get('name', ''))
            self.level_combo.setCurrentText(self.node_data.get('level', 'folder'))
            self.description_edit.setPlainText(self.node_data.get('description', ''))
            self.order_spin.setValue(self.node_data.get('display_order', 0))

            # Set parent info
            self.parent_id = self.node_data.get('parent_id')

            # Update preview
            self._update_preview()

        except Exception as e:
            QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ load node: {e}")
            self.reject()

    def _set_default_values(self):
        """Thi·∫øt l·∫≠p gi√° tr·ªã m·∫∑c ƒë·ªãnh (khi add)"""
        self.level_combo.setCurrentText("folder")
        self.order_spin.setValue(0)
        self._update_preview()

    # ========== PARENT SELECTION ==========

    def set_parent_id(self, parent_id: Optional[int]):
        """Thi·∫øt l·∫≠p parent ID t·ª´ b√™n ngo√†i"""
        self.parent_id = parent_id
        self._update_parent_info()
        self._update_preview()

    def _select_parent(self):
        """Ch·ªçn th∆∞ m·ª•c cha"""
        dialog = ParentSelectorDialog(self.db, self.node_id, self)
        if dialog.exec() == QDialog.Accepted:
            self.parent_id = dialog.selected_parent_id
            self._update_parent_info()
            self._update_preview()

    def _clear_parent(self):
        """X√≥a l·ª±a ch·ªçn parent"""
        self.parent_id = None
        self._update_parent_info()
        self._update_preview()

    def _update_parent_info(self):
        """C·∫≠p nh·∫≠t hi·ªÉn th·ªã th√¥ng tin parent"""
        if not hasattr(self, 'parent_info_label'):
            return

        if self.parent_id:
            try:
                parent = self.db.execute_query(
                    "SELECT name FROM exercise_tree WHERE id = ?",
                    (self.parent_id,), fetch="one"
                )
                if parent:
                    path = self._get_parent_path(self.parent_id)
                    self.parent_info_label.setText(f"üìÅ {path}")
                else:
                    self.parent_info_label.setText("‚ùå Parent kh√¥ng t·ªìn t·∫°i")
            except Exception:
                self.parent_info_label.setText("‚ùå L·ªói load parent")
        else:
            self.parent_info_label.setText("üå± Th∆∞ m·ª•c g·ªëc (Root)")

    def _get_parent_path(self, parent_id: int) -> str:
        """L·∫•y ƒë∆∞·ªùng d·∫´n c·ªßa parent"""
        try:
            path_parts = []
            current_id = parent_id

            while current_id:
                node = self.db.execute_query(
                    "SELECT id, parent_id, name FROM exercise_tree WHERE id = ?",
                    (current_id,), fetch="one"
                )
                if not node:
                    break

                path_parts.insert(0, node['name'])
                current_id = node['parent_id']

            return " > ".join(path_parts)

        except Exception:
            return "L·ªói ƒë∆∞·ªùng d·∫´n"

    # ========== VALIDATION ==========

    def _validate_input(self) -> bool:
        """Validate input v·ªõi th√¥ng b√°o chi ti·∫øt"""
        errors = []

        # Validate name
        name = self.name_edit.text().strip()
        if not name:
            errors.append("‚ùå T√™n th∆∞ m·ª•c kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
        elif len(name) > 100:
            errors.append("‚ùå T√™n th∆∞ m·ª•c kh√¥ng ƒë∆∞·ª£c qu√° 100 k√Ω t·ª±")
        elif not re.match(r'^[^<>:"/\\|?*]+$', name):
            errors.append("‚ùå T√™n th∆∞ m·ª•c ch·ª©a k√Ω t·ª± kh√¥ng h·ª£p l·ªá")

        # Validate description
        description = self.description_edit.toPlainText()
        if len(description) > 1000:
            errors.append("‚ùå M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c qu√° 1000 k√Ω t·ª±")

        # Check duplicate name (trong c√πng parent)
        if self._check_duplicate_name(name):
            errors.append("‚ùå T√™n th∆∞ m·ª•c ƒë√£ t·ªìn t·∫°i trong c√πng c·∫•p")

        # Show validation results
        if errors:
            QMessageBox.warning(self, "L·ªói validation", "\n".join(errors))
            return False
        else:
            QMessageBox.information(self, "‚úÖ H·ª£p l·ªá", "Th√¥ng tin h·ª£p l·ªá!")
            return True

    def _check_duplicate_name(self, name: str) -> bool:
        """Ki·ªÉm tra tr√πng t√™n trong c√πng parent"""
        try:
            existing = self.db.execute_query(
                "SELECT id FROM exercise_tree WHERE name = ? AND parent_id = ? AND id != ?",
                (name, self.parent_id, self.node_id or -1), fetch="one"
            )
            return existing is not None
        except Exception:
            return False

    # ========== PREVIEW ==========

    def _update_preview(self):
        """C·∫≠p nh·∫≠t preview"""
        name = self.name_edit.text().strip()
        level = self.level_combo.currentText()
        description = self.description_edit.toPlainText().strip()

        if not name:
            self.preview_label.setText("üëª Nh·∫≠p t√™n ƒë·ªÉ xem preview")
            return

        # Create preview text
        icon = self._get_level_icon(level)
        preview_text = f"{icon} {name}"

        if description:
            preview_text += f"\nüí≠ {description[:50]}{'...' if len(description) > 50 else ''}"

        # Parent path
        if self.parent_id:
            parent_path = self._get_parent_path(self.parent_id)
            preview_text += f"\nüìç V·ªã tr√≠: {parent_path} > {name}"
        else:
            preview_text += f"\nüìç V·ªã tr√≠: (Root) > {name}"

        self.preview_label.setText(preview_text)

    def _get_level_icon(self, level: str) -> str:
        """L·∫•y icon cho t·ª´ng lo·∫°i level"""
        icons = {
            "folder": "üìÅ",
            "subject": "üìö",
            "chapter": "üìñ",
            "section": "üìÑ",
            "topic": "üéØ",
            "difficulty": "‚≠ê",
            "exam_type": "üìã"
        }
        return icons.get(level, "üìÅ")

    def _on_level_changed(self, level: str):
        """X·ª≠ l√Ω khi thay ƒë·ªïi level"""
        # Auto-fill description based on level
        if not self.description_edit.toPlainText():
            descriptions = {
                "folder": "Th∆∞ m·ª•c t·ªï ch·ª©c c√°c n·ªôi dung con",
                "subject": "M√¥n h·ªçc v·ªõi c√°c ch∆∞∆°ng b√†i h·ªçc",
                "chapter": "Ch∆∞∆°ng h·ªçc v·ªõi c√°c ph·∫ßn nh·ªè",
                "section": "Ph·∫ßn h·ªçc v·ªõi c√¢u h·ªèi c·ª• th·ªÉ",
                "topic": "Ch·ªß ƒë·ªÅ c·ª• th·ªÉ",
                "difficulty": "Ph√¢n lo·∫°i theo ƒë·ªô kh√≥",
                "exam_type": "Ph√¢n lo·∫°i theo lo·∫°i ƒë·ªÅ thi"
            }

            if level in descriptions:
                self.description_edit.setPlaceholderText(descriptions[level])

        self._update_preview()

    # ========== SAVE LOGIC ==========

    def _save_node(self):
        """L∆∞u node"""
        # Validate first
        if not self._validate_input_silent():
            return

        try:
            name = self.name_edit.text().strip()
            level = self.level_combo.currentText()
            description = self.description_edit.toPlainText().strip()
            display_order = self.order_spin.value()

            if self.mode == "edit":
                # Update existing node
                self.db.execute_query(
                    """UPDATE exercise_tree 
                       SET name = ?, level = ?, description = ?, 
                           display_order = ?, modified_at = datetime('now')
                       WHERE id = ?""",
                    (name, level, description, display_order, self.node_id)
                )

                saved_id = self.node_id
                action = "c·∫≠p nh·∫≠t"

            else:
                # Insert new node
                saved_id = self.db.execute_query(
                    """INSERT INTO exercise_tree 
                       (parent_id, name, level, description, display_order, created_at)
                       VALUES (?, ?, ?, ?, ?, datetime('now'))""",
                    (self.parent_id, name, level, description, display_order)
                )

                if not saved_id:
                    QMessageBox.critical(self, "L·ªói", "Kh√¥ng th·ªÉ t·∫°o th∆∞ m·ª•c m·ªõi")
                    return

                action = "t·∫°o"

            # Emit signal
            self.node_saved.emit(saved_id)

            QMessageBox.information(self, "Th√†nh c√¥ng", f"ƒê√£ {action} th∆∞ m·ª•c '{name}'")
            self.accept()

        except Exception as e:
            QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ l∆∞u: {e}")

    def _validate_input_silent(self) -> bool:
        """Validate input kh√¥ng hi·ªán th√¥ng b√°o"""
        name = self.name_edit.text().strip()

        if not name:
            self.name_edit.setFocus()
            return False

        if len(name) > 100:
            self.name_edit.setFocus()
            return False

        if not re.match(r'^[^<>:"/\\|?*]+$', name):
            self.name_edit.setFocus()
            return False

        if self._check_duplicate_name(name):
            self.name_edit.setFocus()
            return False

        return True


class ParentSelectorDialog(QDialog):
    """Dialog ch·ªçn th∆∞ m·ª•c cha"""

    def __init__(self, db_manager, exclude_node_id=None, parent=None):
        super().__init__(parent)
        self.db = db_manager
        self.exclude_node_id = exclude_node_id
        self.selected_parent_id: Optional[int] = None

        self._setup_window()
        self._setup_ui()
        self._load_tree()

    def _setup_window(self):
        """Thi·∫øt l·∫≠p c·ª≠a s·ªï"""
        self.setWindowTitle("üìÅ Ch·ªçn th∆∞ m·ª•c cha")
        self.setModal(True)
        self.resize(400, 500)

    def _setup_ui(self):
        """Thi·∫øt l·∫≠p giao di·ªán"""
        layout = QVBoxLayout(self)
        layout.setContentsMargins(10, 10, 10, 10)

        # Instructions
        info_label = QLabel("üéØ Ch·ªçn th∆∞ m·ª•c l√†m parent ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·∫°o root node")
        info_label.setStyleSheet("color: #666; margin-bottom: 10px;")
        layout.addWidget(info_label)

        # Tree widget
        self.tree = QTreeWidget()
        self.tree.setHeaderLabels(["üìÅ Th∆∞ m·ª•c", "üìä Lo·∫°i"])
        self.tree.setRootIsDecorated(True)
        self.tree.setAlternatingRowColors(True)

        # Selection handling
        self.tree.itemSelectionChanged.connect(self._on_selection_changed)
        self.tree.itemDoubleClicked.connect(self._on_double_click)

        layout.addWidget(self.tree)

        # Selection info
        self.selection_label = QLabel("Ch∆∞a ch·ªçn th∆∞ m·ª•c n√†o")
        self.selection_label.setStyleSheet("""
            QLabel {
                background: #f8f9fa;
                border: 1px solid #dee2e6;
                padding: 8px;
                border-radius: 4px;
            }
        """)
        layout.addWidget(self.selection_label)

        # Buttons
        button_layout = QHBoxLayout()

        # Root option
        root_btn = QPushButton("üå± Ch·ªçn Root")
        root_btn.clicked.connect(self._select_root)
        button_layout.addWidget(root_btn)

        button_layout.addStretch()

        # Cancel & OK
        cancel_btn = QPushButton("‚ùå H·ªßy")
        cancel_btn.clicked.connect(self.reject)
        button_layout.addWidget(cancel_btn)

        self.ok_btn = QPushButton("‚úÖ Ch·ªçn")
        self.ok_btn.setDefault(True)
        self.ok_btn.clicked.connect(self.accept)
        self.ok_btn.setEnabled(False)
        button_layout.addWidget(self.ok_btn)

        layout.addLayout(button_layout)

    def _load_tree(self):
        """Load c√¢y th∆∞ m·ª•c"""
        try:
            self.tree.clear()

            # Load all nodes except the one being edited
            query = "SELECT id, parent_id, name, level FROM exercise_tree"
            params = []

            if self.exclude_node_id:
                query += " WHERE id != ?"
                params.append(self.exclude_node_id)

            query += " ORDER BY parent_id, name"

            nodes = self.db.execute_query(query, params, fetch="all") or []

            # Build tree structure
            node_items = {}
            root_items = []

            for node in nodes:
                item = QTreeWidgetItem()
                item.setText(0, node['name'])
                item.setText(1, node['level'])
                item.setData(0, Qt.UserRole, node['id'])

                # Icon based on level
                icon = self._get_level_icon(node['level'])
                item.setText(0, f"{icon} {node['name']}")

                node_items[node['id']] = {
                    'item': item,
                    'parent_id': node['parent_id']
                }

            # Build hierarchy
            for node_id, node_info in node_items.items():
                parent_id = node_info['parent_id']
                if parent_id and parent_id in node_items:
                    node_items[parent_id]['item'].addChild(node_info['item'])
                else:
                    root_items.append(node_info['item'])

            self.tree.addTopLevelItems(root_items)
            self.tree.expandAll()

        except Exception as e:
            QMessageBox.critical(self, "L·ªói", f"Kh√¥ng th·ªÉ load c√¢y: {e}")

    def _get_level_icon(self, level: str) -> str:
        """L·∫•y icon cho level"""
        icons = {
            "folder": "üìÅ",
            "subject": "üìö",
            "chapter": "üìñ",
            "section": "üìÑ",
            "topic": "üéØ",
            "difficulty": "‚≠ê",
            "exam_type": "üìã"
        }
        return icons.get(level, "üìÅ")

    def _on_selection_changed(self):
        """X·ª≠ l√Ω khi selection thay ƒë·ªïi"""
        items = self.tree.selectedItems()
        if items:
            item = items[0]
            self.selected_parent_id = item.data(0, Qt.UserRole)

            # Get path
            path = self._get_item_path(item)
            self.selection_label.setText(f"üìç ƒê√£ ch·ªçn: {path}")
            self.selection_label.setStyleSheet("""
                QLabel {
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    padding: 8px;
                    border-radius: 4px;
                    color: #155724;
                }
            """)

            self.ok_btn.setEnabled(True)
        else:
            self.selected_parent_id = None
            self.selection_label.setText("Ch∆∞a ch·ªçn th∆∞ m·ª•c n√†o")
            self.ok_btn.setEnabled(False)

    def _on_double_click(self, item, column):
        """X·ª≠ l√Ω double click"""
        self._on_selection_changed()
        if self.selected_parent_id:
            self.accept()

    def _select_root(self):
        """Ch·ªçn root l√†m parent"""
        self.selected_parent_id = None
        self.selection_label.setText("üå± ƒê√£ ch·ªçn: Root (Th∆∞ m·ª•c g·ªëc)")
        self.selection_label.setStyleSheet("""
            QLabel {
                background: #d1ecf1;
                border: 1px solid #bee5eb;
                padding: 8px;
                border-radius: 4px;
                color: #0c5460;
            }
        """)
        self.ok_btn.setEnabled(True)

    def _get_item_path(self, item: QTreeWidgetItem) -> str:
        """L·∫•y ƒë∆∞·ªùng d·∫´n c·ªßa item"""
        path_parts = []
        current_item = item

        while current_item:
            text = current_item.text(0)
            # Remove icon from text
            clean_text = re.sub(r'^[^\w\s]+\s*', '', text)
            path_parts.insert(0, clean_text)
            current_item = current_item.parent()

        return " > ".join(path_parts)


class NodeTypeTemplateDialog(QDialog):
    """Dialog ch·ªçn template cho node type"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.selected_template: Optional[Dict] = None

        self._setup_window()
        self._setup_ui()

    def _setup_window(self):
        """Thi·∫øt l·∫≠p c·ª≠a s·ªï"""
        self.setWindowTitle("üìã Ch·ªçn Template")
        self.setModal(True)
        self.resize(600, 400)

    def _setup_ui(self):
        """Thi·∫øt l·∫≠p giao di·ªán"""
        layout = QVBoxLayout(self)

        # Info
        info_label = QLabel("üé® Ch·ªçn template ƒë·ªÉ t·ª± ƒë·ªông t·∫°o c·∫•u tr√∫c th∆∞ m·ª•c:")
        layout.addWidget(info_label)

        # Template list
        self.template_list = QtWidgets.QListWidget()
        self.template_list.setAlternatingRowColors(True)

        # Add templates
        templates = self._get_templates()
        for template in templates:
            item = QtWidgets.QListWidgetItem()
            item.setText(f"{template['icon']} {template['name']}\nüí≠ {template['description']}")
            item.setData(Qt.UserRole, template)
            self.template_list.addItem(item)

        self.template_list.itemSelectionChanged.connect(self._on_template_selected)
        self.template_list.itemDoubleClicked.connect(self._on_template_double_clicked)

        layout.addWidget(self.template_list)

        # Preview
        self.preview_text = QTextEdit()
        self.preview_text.setMaximumHeight(120)
        self.preview_text.setReadOnly(True)
        self.preview_text.setPlaceholderText("Ch·ªçn template ƒë·ªÉ xem preview c·∫•u tr√∫c...")
        layout.addWidget(self.preview_text)

        # Buttons
        button_layout = QHBoxLayout()

        button_layout.addStretch()

        cancel_btn = QPushButton("‚ùå H·ªßy")
        cancel_btn.clicked.connect(self.reject)
        button_layout.addWidget(cancel_btn)

        self.apply_btn = QPushButton("‚úÖ √Åp d·ª•ng")
        self.apply_btn.clicked.connect(self.accept)
        self.apply_btn.setEnabled(False)
        button_layout.addWidget(self.apply_btn)

        layout.addLayout(button_layout)

    def _get_templates(self) -> List[Dict]:
        """L·∫•y danh s√°ch templates"""
        return [
            {
                "name": "To√°n h·ªçc c∆° b·∫£n",
                "icon": "üî¢",
                "description": "C·∫•u tr√∫c cho m√¥n To√°n: ƒê·∫°i s·ªë, H√¨nh h·ªçc, Gi·∫£i t√≠ch",
                "structure": [
                    {"name": "ƒê·∫°i s·ªë", "level": "chapter"},
                    {"name": "H√¨nh h·ªçc", "level": "chapter"},
                    {"name": "Gi·∫£i t√≠ch", "level": "chapter"}
                ]
            },
            {
                "name": "V·∫≠t l√Ω c∆° b·∫£n",
                "icon": "‚öõÔ∏è",
                "description": "C·∫•u tr√∫c cho m√¥n V·∫≠t l√Ω: C∆° h·ªçc, Nhi·ªát h·ªçc, ƒêi·ªán h·ªçc",
                "structure": [
                    {"name": "C∆° h·ªçc", "level": "chapter"},
                    {"name": "Nhi·ªát h·ªçc", "level": "chapter"},
                    {"name": "ƒêi·ªán h·ªçc", "level": "chapter"}
                ]
            },
            {
                "name": "Ph√¢n lo·∫°i ƒë·ªô kh√≥",
                "icon": "‚≠ê",
                "description": "Chia theo m·ª©c ƒë·ªô: D·ªÖ, Trung b√¨nh, Kh√≥",
                "structure": [
                    {"name": "D·ªÖ", "level": "difficulty"},
                    {"name": "Trung b√¨nh", "level": "difficulty"},
                    {"name": "Kh√≥", "level": "difficulty"}
                ]
            },
            {
                "name": "Lo·∫°i ƒë·ªÅ thi",
                "icon": "üìã",
                "description": "Chia theo lo·∫°i: Tr·∫Øc nghi·ªám, T·ª± lu·∫≠n, Th·ª±c h√†nh",
                "structure": [
                    {"name": "Tr·∫Øc nghi·ªám", "level": "exam_type"},
                    {"name": "T·ª± lu·∫≠n", "level": "exam_type"},
                    {"name": "Th·ª±c h√†nh", "level": "exam_type"}
                ]
            }
        ]

    def _on_template_selected(self):
        """X·ª≠ l√Ω khi ch·ªçn template"""
        items = self.template_list.selectedItems()
        if items:
            self.selected_template = items[0].data(Qt.UserRole)
            self._update_preview()
            self.apply_btn.setEnabled(True)
        else:
            self.selected_template = None
            self.preview_text.clear()
            self.apply_btn.setEnabled(False)

    def _on_template_double_clicked(self, item):
        """X·ª≠ l√Ω double click template"""
        self.selected_template = item.data(Qt.UserRole)
        self.accept()

    def _update_preview(self):
        """C·∫≠p nh·∫≠t preview template"""
        if not self.selected_template:
            return

        structure = self.selected_template.get('structure', [])
        preview_lines = []

        for node in structure:
            icon = self._get_level_icon(node['level'])
            preview_lines.append(f"  {icon} {node['name']} ({node['level']})")

        preview_text = f"üìã Template: {self.selected_template['name']}\n"
        preview_text += f"üìÑ M√¥ t·∫£: {self.selected_template['description']}\n\n"
        preview_text += "üìÅ C·∫•u tr√∫c s·∫Ω t·∫°o:\n"
        preview_text += "\n".join(preview_lines)

        self.preview_text.setPlainText(preview_text)

    def _get_level_icon(self, level: str) -> str:
        """L·∫•y icon cho level"""
        icons = {
            "folder": "üìÅ",
            "subject": "üìö",
            "chapter": "üìñ",
            "section": "üìÑ",
            "topic": "üéØ",
            "difficulty": "‚≠ê",
            "exam_type": "üìã"
        }
        return icons.get(level, "üìÅ")


# ========== TEST FUNCTIONS ==========

def test_tree_node_dialog():
    """Test TreeNodeDialog"""
    import sys
    from PySide6.QtWidgets import QApplication

    app = QApplication(sys.argv)

    # Mock database
    class MockDB:
        def execute_query(self, query, params=None, fetch=None):
            return None

    dialog = TreeNodeDialog(MockDB(), mode="add")
    dialog.show()

    sys.exit(app.exec())


def test_parent_selector_dialog():
    """Test ParentSelectorDialog"""
    import sys
    from PySide6.QtWidgets import QApplication

    app = QApplication(sys.argv)

    # Mock database
    class MockDB:
        def execute_query(self, query, params=None, fetch=None):
            return [
                {'id': 1, 'parent_id': None, 'name': 'To√°n h·ªçc', 'level': 'subject'},
                {'id': 2, 'parent_id': 1, 'name': 'ƒê·∫°i s·ªë', 'level': 'chapter'},
            ]

    dialog = ParentSelectorDialog(MockDB())
    dialog.show()

    sys.exit(app.exec())


if __name__ == "__main__":
    test_tree_node_dialog()